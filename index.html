<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
:root {
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-border: rgba(94, 82, 64, 0.2);
  --color-card-border: rgba(94, 82, 64, 0.12);
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-primary: var(--color-teal-300);
  }
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--color-background);
  color: var(--color-text);
  line-height: 1.6;
  padding: 20px;
}

.container { max-width: 800px; margin: 0 auto; }
.card {
  background: var(--color-surface);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

h2 { margin-bottom: 16px; }
h3 { margin-bottom: 12px; font-size: 18px; }

.btn {
  display: inline-block;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
  margin-top: 12px;
}

.btn-primary {
  background: var(--color-primary);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--color-primary-hover);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.emergency-btn {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  font-size: 28px;
  background: linear-gradient(135deg, var(--color-red-400), var(--color-red-500));
  color: white;
  border: 4px solid white;
  box-shadow: 0 8px 24px rgba(192, 21, 47, 0.3);
  margin: 30px auto;
  display: block;
}

.emergency-btn:hover:not(:disabled) { transform: scale(1.05); }

.status {
  padding: 8px 16px;
  border-radius: 20px;
  display: inline-block;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 16px;
}

.status-success { background: rgba(33, 128, 141, 0.15); color: var(--color-primary); }
.status-warning { background: rgba(168, 75, 47, 0.15); color: rgba(168, 75, 47, 1); }
.status-error { background: rgba(192, 21, 47, 0.15); color: var(--color-red-500); }

input, select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  margin-top: 8px;
  font-size: 16px;
  background: var(--color-surface);
  color: var(--color-text);
}

label {
  display: block;
  font-weight: 600;
  margin-top: 16px;
}

.video-container {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  margin: 20px 0;
}

.control-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.control-btn:hover { background: rgba(0,0,0,0.8); }
.control-btn.end { background: var(--color-red-500); }

.log-box {
  max-height: 300px;
  overflow-y: auto;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 12px;
  font-family: monospace;
  font-size: 13px;
}

.log-entry {
  padding: 4px 0;
  border-bottom: 1px solid var(--color-border);
}

.hidden { display: none !important; }

.info-box {
  background: rgba(33, 128, 141, 0.1);
  padding: 16px;
  border-radius: 8px;
  margin: 16px 0;
  border-left: 4px solid var(--color-primary);
}

.code-box {
  background: rgba(0,0,0,0.05);
  padding: 12px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 12px;
  word-break: break-all;
  margin-top: 8px;
}

/* --- æ–°ã—ã„ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ãƒ“ãƒ‡ã‚ªé€šè©±UI --- */

/* é€šè©±ç”»é¢ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
.call-area {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: #000;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ãƒ“ãƒ‡ã‚ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸ */
.video-content {
    flex: 1;
    position: relative;
    overflow: hidden;
}

/* ç›¸æ‰‹ã®æ˜ åƒ (ãƒ¡ã‚¤ãƒ³ç”»é¢) */
.remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background-color: #222;
}

/* è‡ªåˆ†ã®æ˜ åƒ (å³ä¸Šã®å°çª“) */
.local-video {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 100px;
    height: 75px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    object-fit: cover;
    background-color: #333;
    z-index: 10;
    transition: opacity 0.3s ease;
}

/* è‡ªåˆ†ã®æ˜ åƒãŒOFFã®æ™‚ */
.local-video.hidden {
    opacity: 0;
    pointer-events: none;
}

/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ï¼ˆç”»é¢ä¸‹éƒ¨ã«å›ºå®šï¼‰ */
.call-controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 90px;
    background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.3));
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 25px;
    padding: 20px;
    z-index: 20;
}

/* å€‹åˆ¥ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ */
.control-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* é€šå¸¸ã®ãƒœã‚¿ãƒ³ï¼ˆãƒã‚¤ã‚¯ã€ã‚«ãƒ¡ãƒ©ã€è‡ªåˆ†æ˜ åƒON/OFFï¼‰ */
.control-btn.normal {
    background-color: rgba(255, 255, 255, 0.15);
    color: white;
    backdrop-filter: blur(10px);
}

.control-btn.normal:hover {
    background-color: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

/* OFFçŠ¶æ…‹ã®ãƒœã‚¿ãƒ³ */
.control-btn.off {
    background-color: #dc3545;
    color: white;
}

.control-btn.off:hover {
    background-color: #c82333;
    transform: scale(1.05);
}

/* é€šè©±çµ‚äº†ãƒœã‚¿ãƒ³ï¼ˆèµ¤è‰²ã€å¤§ãã‚ã§ç›®ç«‹ã¤ï¼‰ */
.control-btn.end-call {
    background-color: #dc3545;
    color: white;
    width: 64px;
    height: 64px;
    font-size: 26px;
}

.control-btn.end-call:hover {
    background-color: #c82333;
    transform: scale(1.1);
}

/* çŠ¶æ…‹è¡¨ç¤ºç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆ */
.status-info {
    position: absolute;
    top: 20px;
    left: 20px;
    background-color: rgba(0,0,0,0.6);
    color: white;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    z-index: 15;
}


    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
        <div id="setupScreen">
            <div class="card">
                <h2>ğŸš¨ ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ </h2>
                
                <div class="info-box">
                    <strong>ã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹å¾´</strong>
                    <ul style="margin-top: 8px; margin-left: 20px;">
                        <li>âœ“ ã‚ãªãŸã®æ“ä½œã§ã®ã¿é€šçŸ¥ç™ºå‹•</li>
                        <li>âœ“ VAPIDæ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä½¿ç”¨ï¼ˆiOS Safariå¯¾å¿œï¼‰</li>
                        <li>âœ“ PeerJS WebRTCã‚·ã‚°ãƒŠãƒªãƒ³ã‚°</li>
                        <li>âœ“ é€šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³IDè‡ªå‹•ç”Ÿæˆ</li>
                        <li>âœ“ èªè¨¼ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å—ä¿¡è€…ç™»éŒ²</li>
                        <li>âœ“ ã‚ªãƒ¼ãƒˆã‚¢ãƒ³ã‚µãƒ¼æ©Ÿèƒ½</li>
                    </ul>
                </div>

                <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—:</label>
                <select id="userType">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="sender">ç™ºä¿¡è€…ï¼ˆç·Šæ€¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™å´ï¼‰</option>
                    <option value="receiver">å—ä¿¡è€…ï¼ˆé€šçŸ¥ã‚’å—ã‘å–ã‚‹å´ï¼‰</option>
                </select>

                <button class="btn btn-primary" onclick="proceedToSetup()">æ¬¡ã¸</button>
            </div>
        </div>

        <!-- æ–°ã—ã„ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="hidden">
            <div class="card">
                <h2>ğŸ“ ç™ºä¿¡è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <p>ç™ºä¿¡ã‚’è¡Œã†ã«ã¯ã€å…±æœ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button class="btn btn-primary" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>

        <!-- ç™ºä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
        <div id="senderSetup" class="hidden">
            <div class="card">
                <h2>ğŸ“ ç™ºä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
                
                <label>å—ä¿¡è€…ID:</label>
                <input type="text" id="receiverId" placeholder="ä¾‹: parent_A">

                <label>ã‚µãƒ¼ãƒãƒ¼URLï¼ˆé€šçŸ¥é€ä¿¡ç”¨ï¼‰:</label>
                <input type="text" id="serverUrl" placeholder="https://your-server.onrender.com" value="__your-server-url__">

                <div class="info-box" style="margin-top: 20px;">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</strong>
                    <p style="margin-top: 8px;">å—ä¿¡è€…IDã¯ã€å—ä¿¡è€…ãŒç™»éŒ²æ™‚ã«ä½¿ç”¨ã—ãŸIDã¨åŒã˜ã‚‚ã®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <button class="btn btn-primary" onclick="initSender()">ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
            </div>
        </div>

        <!-- å—ä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
        <div id="receiverSetup" class="hidden">
            <div class="card">
                <h2>ğŸ“± å—ä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
                
                <label>å—ä¿¡è€…IDï¼ˆã‚ãªãŸã®IDï¼‰:</label>
                <input type="text" id="myReceiverId" placeholder="ä¾‹: parent_A">

                <label>èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆç™ºä¿¡è€…ã‹ã‚‰å—ã‘å–ã£ãŸ6æ¡ï¼‰:</label>
                <input type="text" id="authCode" placeholder="ä¾‹: 582937" maxlength="6">

                <label>ã‚µãƒ¼ãƒãƒ¼URL:</label>
                <input type="text" id="receiverServerUrl" placeholder="https://your-server.onrender.com" value="__your-server-url__">

                <div class="info-box" style="margin-top: 20px;">
                    <strong>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>
                    <p style="margin-top: 8px;">èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯ç™ºä¿¡è€…ã‹ã‚‰åˆ¥ã®å®‰å…¨ãªæ–¹æ³•ï¼ˆé›»è©±ãªã©ï¼‰ã§å—ã‘å–ã£ã¦ãã ã•ã„ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€ã‚ãªãŸã ã‘ãŒã“ã®IDã«ç™»éŒ²ã§ãã¾ã™ã€‚</p>
                </div>

                <button class="btn btn-primary" onclick="initReceiver()">å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
            </div>
        </div>

        <!-- ç™ºä¿¡è€…ç”»é¢ -->
        <div id="senderScreen" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin-bottom: 0;">ğŸ“ ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰</h2>
                    <button class="btn" style="width: auto; margin-top: 0;" onclick="goBackToHome()">ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´</button>
                </div>
                <div id="senderStatus" class="status status-warning">åˆæœŸåŒ–ä¸­...</div>

                <button class="emergency-btn" id="callBtn" onclick="makeEmergencyCall()" disabled>
                    ç·Šæ€¥<br>ã‚³ãƒ¼ãƒ«
                </button>

                <div id="senderCallArea" class="hidden">
                    <div class="video-container">
                        <div class="call-area">
                            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                            <div class="status-info">é€šè©±ä¸­</div>
                            
                            <!-- ãƒ“ãƒ‡ã‚ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                            <div class="video-content">
                                <video id="senderRemoteVideo" class="remote-video" autoplay playsinline></video>
                                <video id="senderLocalVideo" class="local-video" autoplay muted playsinline></video>
                            </div>
                            
                            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                            <div class="call-controls">
                                <button id="senderMicBtn" class="control-btn normal" onclick="toggleMute('sender')" title="ãƒã‚¤ã‚¯">ğŸ¤</button>
                                <button id="senderCameraBtn" class="control-btn normal" onclick="toggleCamera('sender')" title="ã‚«ãƒ¡ãƒ©">ğŸ“·</button>
                                <button id="senderSelfViewBtn" class="control-btn normal" onclick="toggleSelfView('sender')" title="è‡ªåˆ†ã®æ˜ åƒ">ğŸ‘ï¸</button>
                                <button class="control-btn end-call" onclick="endCall('sender')" title="é€šè©±çµ‚äº†">ğŸ“</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å—ä¿¡è€…ç”»é¢ -->
        <div id="receiverScreen" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin-bottom: 0;">ğŸ“± å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰</h2>
                    <button class="btn" style="width: auto; margin-top: 0;" onclick="goBackToHome()">ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´</button>
                </div>
                <div id="receiverStatus" class="status status-warning">åˆæœŸåŒ–ä¸­...</div>
                
                <div id="subscriptionInfo" class="hidden">
                    <h3>ç™»éŒ²æƒ…å ±</h3>
                    <p>ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
                    <div class="code-box" id="subscriptionData"></div>
                </div>

                <div id="receiverCallArea" class="hidden">
                    <div class="video-container">
                        <div class="call-area">
                            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                            <div class="status-info">é€šè©±ä¸­</div>
                            
                            <!-- ãƒ“ãƒ‡ã‚ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                            <div class="video-content">
                                <video id="receiverRemoteVideo" class="remote-video" autoplay playsinline></video>
                                <video id="receiverLocalVideo" class="local-video" autoplay muted playsinline></video>
                            </div>
                            
                            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                            <div class="call-controls">
                                <button id="receiverMicBtn" class="control-btn normal" onclick="toggleMute('receiver')" title="ãƒã‚¤ã‚¯">ğŸ¤</button>
                                <button id="receiverCameraBtn" class="control-btn normal" onclick="toggleCamera('receiver')" title="ã‚«ãƒ¡ãƒ©">ğŸ“·</button>
                                <button id="receiverSelfViewBtn" class="control-btn normal" onclick="toggleSelfView('receiver')" title="è‡ªåˆ†ã®æ˜ åƒ">ğŸ‘ï¸</button>
                                <button class="control-btn end-call" onclick="endCall('receiver')" title="é€šè©±çµ‚äº†">ğŸ“</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ­ã‚° -->
        <div class="card">
            <h3>ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h3>
            <div class="log-box" id="logBox"></div>
        </div>
    </div>

    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

    <script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let userType = null;
let config = {
    receiverId: null,
    serverUrl: null,
    authCode: null
};
let peer = null;
let currentCall = null;
let localStream = null;
let pushSubscription = null;
let sessionId = null;
let sessionToken = null; // ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿æŒ

// ãƒ­ã‚°é–¢æ•°
function log(msg, type = 'info') {
    const logBox = document.getElementById('logBox');
    const time = new Date().toLocaleTimeString('ja-JP');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.textContent = `[${time}] ${msg}`;
    logBox.appendChild(entry);
    logBox.scrollTop = logBox.scrollHeight;
    console.log(`[${type}] ${msg}`);
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²è¡Œ
function proceedToSetup() {
    const type = document.getElementById('userType').value;
    if (!type) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    userType = type;
    document.getElementById('setupScreen').classList.add('hidden');
    
    if (type === 'sender') {
        // ç™ºä¿¡è€…ã®å ´åˆã¯ã€ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
        document.getElementById('loginScreen').classList.remove('hidden');
    } else {
        document.getElementById('receiverSetup').classList.remove('hidden');
    }
}

// --- æ–°ã—ã„handleLoginé–¢æ•° ---
async function handleLogin() {
    const password = document.getElementById('password').value;
    const serverUrl = document.getElementById('serverUrl').value || document.getElementById('receiverServerUrl').value;
    
    if (!password || !serverUrl) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã‚µãƒ¼ãƒãƒ¼URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    try {
        const response = await fetch(`${serverUrl}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: password })
        });
        
        const result = await response.json();
        
        if (result.success) {
            log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
            sessionToken = result.token; // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
            
            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éš ã—ã€ç™ºä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('senderSetup').classList.remove('hidden');
        } else {
            throw new Error(result.error || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    } catch (error) {
        log(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// ç™ºä¿¡è€…åˆæœŸåŒ–
async function initSender() {
    // UIã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ä¿å­˜
    saveConfig();
    
    if (!config.receiverId || !config.serverUrl) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    document.getElementById('senderSetup').classList.add('hidden');
    document.getElementById('senderScreen').classList.remove('hidden');
    
    log('ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...');

    // PeerJSæ¥ç¶šã‚’ç®¡ç†ã™ã‚‹é–¢æ•°ã‚’å®šç¾©
    function connectToPeerJS() {
        if (peer && !peer.destroyed) {
            log('æ—¢å­˜ã®Peeræ¥ç¶šã‚’ç ´æ£„ã—ã¾ã™ã€‚');
            peer.destroy();
        }

        const peerId = 'sender_' + Date.now();
        log(`PeerJSã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šè©¦è¡Œ... ID: ${peerId}`);
        document.getElementById('senderStatus').textContent = 'ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šä¸­...';
        document.getElementById('senderStatus').className = 'status status-warning';
        document.getElementById('callBtn').disabled = true;

        // PeerJSåˆæœŸåŒ–ï¼ˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã¨å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ï¼‰
        peer = new Peer(peerId, {
            host: '0.peerjs.com',
            secure: true,
            port: 443,
            pingInterval: 5000 // 5ç§’ã”ã¨ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¦æ¥ç¶šã‚’ç¶­æŒ
        });
        
        peer.on('open', (id) => {
            log(`âœ… PeerJSæ¥ç¶šæˆåŠŸ: ${id}`);
            document.getElementById('senderStatus').textContent = 'æº–å‚™å®Œäº†';
            document.getElementById('senderStatus').className = 'status status-success';
            document.getElementById('callBtn').disabled = false;
        });
        
        // ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒä¸€æ™‚çš„ã«åˆ‡æ–­ã•ã‚ŒãŸå ´åˆ
        peer.on('disconnected', () => {
            log('PeerJSã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚è‡ªå‹•å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...', 'warning');
            document.getElementById('senderStatus').textContent = 'å†æ¥ç¶šä¸­...';
            document.getElementById('senderStatus').className = 'status status-warning';
            // PeerJSã¯å†…éƒ¨ã§è‡ªå‹•çš„ã«å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™
        });

        // æ¥ç¶šãŒå®Œå…¨ã«é–‰ã˜ãŸå ´åˆï¼ˆdestroyã•ã‚ŒãŸæ™‚ãªã©ï¼‰
        peer.on('close', () => {
            log('PeerJSæ¥ç¶šãŒå®Œå…¨ã«é–‰ã˜ã¾ã—ãŸã€‚', 'error');
        });

        // ä½•ã‚‰ã‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
        peer.on('error', (err) => {
            log(`PeerJSã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            document.getElementById('senderStatus').textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            document.getElementById('senderStatus').className = 'status status-error';
            
            // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
            if (err.type === 'network' || err.type === 'server-error') {
                log('æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€5ç§’å¾Œã«å†æ¥ç¶šã—ã¾ã™ã€‚');
                setTimeout(connectToPeerJS, 5000);
            } else if (err.type !== 'peer-unavailable') {
                 log('å›å¾©ä¸èƒ½ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚');
            }
        });
        
        // ç€ä¿¡å‡¦ç†ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“
        peer.on('call', (call) => {
            // æ¡ä»¶åˆ†å²ã‚’å‰Šé™¤ã—ã€å¸¸ã«ç€ä¿¡ã«å¿œç­”ã™ã‚‹
            log('ç€ä¿¡ã‚’å—ä¿¡ã€å¿œç­”ã—ã¾ã™ã€‚');
            
            // localStreamãŒnullã®å ´åˆã§ã‚‚ã€ãã®ã¾ã¾æ¸¡ã™ã“ã¨ã§å—ä¿¡å°‚ç”¨ã®æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã‚‹
            answerIncomingCall(call, localStream);
        });
    }

    // åˆå›ã®æ¥ç¶šã‚’é–‹å§‹
    connectToPeerJS();
}


// å—ä¿¡è€…åˆæœŸåŒ–
async function initReceiver() {
    // UIã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ä¿å­˜
    saveConfig();
    // authCodeã¯ä¸€æ™‚çš„ãªã‚‚ã®ãªã®ã§ä¿å­˜ã—ãªã„
    config.authCode = document.getElementById('authCode').value;
    
    if (!config.receiverId || !config.authCode || !config.serverUrl) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (config.authCode.length !== 6) {
        alert('èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯6æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    document.getElementById('receiverSetup').classList.add('hidden');
    document.getElementById('receiverScreen').classList.remove('hidden');
    
    log('å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...');
    
    // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è³¼èª­
    await subscribeToPush();
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•å¿œç­”ãƒã‚§ãƒƒã‚¯
    checkAutoAnswer();
}

// Service Workerç™»éŒ²
async function registerServiceWorker() {
    try {
        if (!('serviceWorker' in navigator)) {
            throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Service Workerã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }

        log('Service Workerã‚’ç™»éŒ²ä¸­...');
        
        // ç‰©ç†ãƒ•ã‚¡ã‚¤ãƒ« '/sw.js' ã‚’ç™»éŒ²
        const registration = await navigator.serviceWorker.register('/sw.js');
        
        log('âœ… Service Workerç™»éŒ²å®Œäº†');
        return registration;
        
    } catch (error) {
        log(`Service Workerã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        // ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«ã‚‚è¡¨ç¤º
        document.getElementById('receiverStatus').textContent = `ç™»éŒ²å¤±æ•—: ${error.message}`;
        document.getElementById('receiverStatus').className = 'status status-error';
        throw error; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¦å‡¦ç†ã‚’ä¸­æ–­
    }
}


// ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è³¼èª­
async function subscribeToPush() {
    try {
        log('ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’è³¼èª­ä¸­...');

        // æ©Ÿèƒ½åˆ¤å®šï¼ˆiOSã¯ç‰¹ã«å³ã—ã„è¦ä»¶ãŒã‚ã‚‹ãŸã‚è©³ç´°ã«ãƒã‚§ãƒƒã‚¯ï¼‰
        if (!('serviceWorker' in navigator)) {
            throw new Error('Service Workeréå¯¾å¿œã§ã™ã€‚');
        }
        if (!('PushManager' in window)) {
            // iOSã§ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ’ãƒ³ãƒˆ
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            if (/iP(ad|hone|od)/.test(navigator.userAgent) && !isStandalone) {
                 throw new Error('Push APIéå¯¾å¿œã§ã™ã€‚iOSã§ã¯ã€ã¾ãšãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‹ã‚‰ã€ãã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
            }
            throw new Error('Push APIéå¯¾å¿œç’°å¢ƒã§ã™ï¼ˆiOSã¯16.4+ã®ãƒ›ãƒ¼ãƒ ç”»é¢Webã‚¢ãƒ—ãƒªãŒå¿…è¦ï¼‰');
        }
        if (typeof Notification === 'undefined') {
            throw new Error('Notification APIéå¯¾å¿œã§ã™ã€‚iOSã¯16.4ä»¥ä¸Šã§ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ å¾Œã€å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // é€šçŸ¥æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            throw new Error('é€šçŸ¥æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }
        
        const registration = await navigator.serviceWorker.ready;

        
        // VAPIDã‚­ãƒ¼ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ï¼‰
        const vapidPublicKey = '__REDACTED_VAPID_PUBLIC_KEY__';
        
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });
        
        pushSubscription = subscription;
        log('ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­å®Œäº†');
        
        // ã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²
        await registerToServer(subscription);
        
    } catch (error) {
        log(`ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

// ã‚µãƒ¼ãƒãƒ¼ã«è³¼èª­æƒ…å ±ã‚’ç™»éŒ²
async function registerToServer(subscription) {
    try {
        log('ã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²ä¸­...');
        
        const response = await fetch(`${config.serverUrl}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receiverId: config.receiverId,
                authCode: config.authCode,
                subscription: subscription
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            log('âœ… ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²æˆåŠŸ', 'success');
            document.getElementById('receiverStatus').textContent = 'é€šçŸ¥å¾…æ©Ÿä¸­';
            document.getElementById('receiverStatus').className = 'status status-success';
            
            document.getElementById('subscriptionInfo').classList.remove('hidden');
            document.getElementById('subscriptionData').textContent = 
                `å—ä¿¡è€…ID: ${config.receiverId}\nç™»éŒ²æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;
        } else {
            throw new Error(result.error || 'ç™»éŒ²å¤±æ•—');
        }
        
    } catch (error) {
        log(`ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// ---ã“ã“ã‹ã‚‰è¿½åŠ ---

// è¨­å®šã‚’localStorageã«ä¿å­˜ã™ã‚‹
function saveConfig() {
    // ç¾åœ¨ã®UIãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æœ€æ–°ã®å€¤ã‚’å–å¾—ã—ã¦configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°
    // userTypeã«å¿œã˜ã¦ä¿å­˜ã™ã‚‹å†…å®¹ã‚’åˆ†ã‘ã‚‹
    if (userType === 'sender') {
        config.receiverId = document.getElementById('receiverId').value;
        config.serverUrl = document.getElementById('serverUrl').value;
    } else if (userType === 'receiver') {
        config.receiverId = document.getElementById('myReceiverId').value;
        config.serverUrl = document.getElementById('receiverServerUrl').value;
    }
    
    // userTypeã‚‚ä¿å­˜å¯¾è±¡ã«å«ã‚ã‚‹
    const configToSave = {
        userType: userType,
        receiverId: config.receiverId,
        serverUrl: config.serverUrl,
    };

    localStorage.setItem('emergencyCallConfig', JSON.stringify(configToSave));
    log('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}

// localStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
function loadSavedConfig() {
    const savedConfig = localStorage.getItem('emergencyCallConfig');
    if (savedConfig) {
        const parsedConfig = JSON.parse(savedConfig);
        config = { ...config, ...parsedConfig }; // ã‚°ãƒ­ãƒ¼ãƒãƒ«configã‚’æ›´æ–°
        
        // UIã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚å€¤ã‚’åæ˜ ã•ã›ã‚‹
        document.getElementById('userType').value = config.userType || '';
        document.getElementById('receiverId').value = config.receiverId || '';
        document.getElementById('myReceiverId').value = config.receiverId || '';
        document.getElementById('serverUrl').value = config.serverUrl || '';
        document.getElementById('receiverServerUrl').value = config.serverUrl || '';

        log('ä¿å­˜æ¸ˆã¿è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
        return true;
    }
    log('ä¿å­˜ã•ã‚ŒãŸè¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
    return false;
}


// Base64å¤‰æ›
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// ç·Šæ€¥ã‚³ãƒ¼ãƒ«ç™ºä¿¡
async function makeEmergencyCall() {
    log('ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚’é–‹å§‹...');
    document.getElementById('callBtn').disabled = true;

    // --- è¨ºæ–­ãƒ­ã‚°ã®è¿½åŠ  ---
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        log('åˆ©ç”¨å¯èƒ½ãªãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‡ãƒã‚¤ã‚¹:');
        devices.forEach(device => {
            log(`- ${device.kind}: ${device.label || 'label not available'} (ID: ${device.deviceId.substring(0,10)}...)`);
        });
        if (!devices.some(d => d.kind === 'videoinput')) log('è­¦å‘Š: ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
        if (!devices.some(d => d.kind === 'audioinput')) log('è­¦å‘Š: ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
    } catch (e) {
        log(`ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—: ${e.message}`, 'error');
    }
    // --------------------

    // --- äº‹å‰ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã®è¿½åŠ  ---
    // ä¸‡ãŒä¸€ã€å¤ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæ®‹ã£ã¦ã„ãŸå ´åˆã«åœæ­¢ã•ã›ã‚‹
    if (localStream) {
        log('å¤ã„ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæ®‹ã£ã¦ã„ã‚‹ãŸã‚ã€å¼·åˆ¶çš„ã«åœæ­¢ã—ã¾ã™ã€‚', 'warning');
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    // ---------------------------------

    try {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
        sessionId = 'emergency_' + Date.now();
        log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}`);
        

        // ãƒ¡ãƒ‡ã‚£ã‚¢å–å¾—ã‚’æŸ”è»Ÿã«å¤‰æ›´
        log('ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦ã¿ã¾ã™...');
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            log('âœ… ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
        } catch (streamError) {
            log(`ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—: ${streamError.name} - ${streamError.message}`, 'warning');
            log('éŸ³å£°ã®ã¿ã§ã®æ¥ç¶šã‚’è©¦ã¿ã¾ã™...');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });
                log('âœ… ãƒã‚¤ã‚¯ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
            } catch (audioError) {
                log('ãƒã‚¤ã‚¯ã®å–å¾—ã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚è¦–è´ã®ã¿ã§æ¥ç¶šã—ã¾ã™ã€‚', 'warning');
                // ã“ã®å ´åˆã€localStreamã¯nullã®ã¾ã¾
                localStream = null;
            }
        }

        // UIã®æ›´æ–° (localStreamãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
        if (localStream) {
            document.getElementById('senderLocalVideo').srcObject = localStream;
        }
        document.getElementById('senderCallArea').classList.remove('hidden');ument.getElementById('senderCallArea').classList.remove('hidden');
            
        // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
        await sendPushNotification();
        
        // PeerJSé€šè©±å¾…æ©Ÿï¼ˆå—ä¿¡è€…ã‹ã‚‰ã®æ¥ç¶šã‚’å¾…ã¤ï¼‰
        log('å—ä¿¡è€…ã®æ¥ç¶šã‚’å¾…æ©Ÿä¸­...');
        
    } catch (error) {
        log(`ç™ºä¿¡ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`, 'error');
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ç¢ºå®Ÿã«ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã—ã€UIã‚’å…ƒã«æˆ»ã™
        endCall('sender'); 
        alert(`ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒã‚¤ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»–ã®ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ä¸­ã§ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: ${error.name}`);
    }
}

// ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
async function sendPushNotification() {
    if (!sessionToken) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        goBackToHome(); // åˆæœŸç”»é¢ã«æˆ»ã™
        return;
    }
    
    try {
        log('ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ä¸­...');
        
        const response = await fetch(`${config.serverUrl}/send-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionToken}` // --- ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¿½åŠ  ---
            },
            body: JSON.stringify({
                receiverId: config.receiverId,
                sessionId: sessionId,
                senderId: peer.id,
                title: 'ğŸš¨ ç·Šæ€¥ã‚³ãƒ¼ãƒ«',
                body: 'ç·Šæ€¥é€šè©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚ã‚¿ãƒƒãƒ—ã—ã¦å¿œç­”ã—ã¦ãã ã•ã„ã€‚'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            log('âœ… ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡æˆåŠŸ', 'success');
        } else {
            throw new Error(result.error || 'é€šçŸ¥é€ä¿¡å¤±æ•—');
        }
        
    } catch (error) {
        log(`é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

// è‡ªå‹•å¿œç­”ãƒã‚§ãƒƒã‚¯
function checkAutoAnswer() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('autoAnswer') === 'true') {
        const sessionId = urlParams.get('sessionId');
        log(`è‡ªå‹•å¿œç­”ãƒ¢ãƒ¼ãƒ‰: ${sessionId}`);
        setTimeout(() => autoAnswerCall(sessionId), 1000);
    }
}

// è‡ªå‹•å¿œç­”
async function autoAnswerCall(sessionId, senderId) {
    try {
        log('è‡ªå‹•å¿œç­”ã‚’é–‹å§‹...');

        // ãƒ¡ãƒ‡ã‚£ã‚¢å–å¾—ã‚’æŸ”è»Ÿã«å¤‰æ›´
        log('ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦ã¿ã¾ã™...');
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            log('âœ… ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
        } catch (streamError) {
            log(`ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—: ${streamError.name} - ${streamError.message}`, 'warning');
            log('éŸ³å£°ã®ã¿ã§ã®æ¥ç¶šã‚’è©¦ã¿ã¾ã™...');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });
                log('âœ… ãƒã‚¤ã‚¯ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
            } catch (audioError) {
                log('ãƒã‚¤ã‚¯ã®å–å¾—ã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚è¦–è´ã®ã¿ã§æ¥ç¶šã—ã¾ã™ã€‚', 'warning');
                localStream = null;
            }
        }

        // UIã®æ›´æ–°
        if (localStream) {
            document.getElementById('receiverLocalVideo').srcObject = localStream;
        }
        document.getElementById('receiverCallArea').classList.remove('hidden');

        
        // PeerJSæ¥ç¶šï¼ˆå¼•æ•°ã§å—ã‘å–ã£ãŸsenderIdã‚’ä½¿ç”¨ï¼‰
        log(`ç™ºä¿¡è€…(${senderId})ã«æ¥ç¶šä¸­...`);
        
        const receiverPeer = new Peer('receiver_' + Date.now(), {
            host: '0.peerjs.com',
            secure: true,
            port: 443,
            // ICEã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚‚é©ç”¨
            config: { iceServers: await getIceServers() } 
        });
        
        receiverPeer.on('open', () => {
            log('PeerJSæ¥ç¶šå®Œäº†ã€ç™ºä¿¡è€…ã‚’å‘¼ã³å‡ºã—ä¸­...');
            const call = receiverPeer.call(senderId, localStream);
            
            if (!call) {
                log('ç™ºä¿¡è€…ã¸ã®æ¥ç¶šé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                return;
            }

            currentCall = call;
            
            call.on('stream', (remoteStream) => {
                log('ç™ºä¿¡è€…ã®æ˜ åƒã‚’å—ä¿¡ã—ã¾ã—ãŸ');
                document.getElementById('receiverRemoteVideo').srcObject = remoteStream;
                document.getElementById('receiverStatus').textContent = 'é€šè©±ä¸­';
                document.getElementById('receiverStatus').className = 'status status-success';
            });

            call.on('close', () => {
                log('é€šè©±ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚');
                endCall('receiver');
            });

            call.on('error', (err) => {
                log(`é€šè©±ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã‚‚å¿…ãšé€šè©±ã‚’çµ‚äº†ã™ã‚‹
                endCall('receiver');
            });
        });

        receiverPeer.on('error', (err) => {
            log(`å—ä¿¡è€…Peerã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
        });
        
    } catch (error) {
        log(`è‡ªå‹•å¿œç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        document.getElementById('receiverStatus').textContent = 'å¿œç­”å¤±æ•—';
        document.getElementById('receiverStatus').className = 'status status-error';
    }
}


// ç€ä¿¡å¿œç­”ï¼ˆç™ºä¿¡è€…å´ï¼‰
function answerIncomingCall(call, stream) { // å¼•æ•°ã«streamã‚’è¿½åŠ 
    log('ç€ä¿¡ã«å¿œç­”ã—ã¾ã™...');
    currentCall = call;
    
    call.answer(stream);
    
    call.on('stream', (remoteStream) => {
        log('å—ä¿¡è€…ã®æ˜ åƒã‚’å—ä¿¡');
        document.getElementById('senderRemoteVideo').srcObject = remoteStream;
    });
    
    call.on('close', () => {
        log('é€šè©±ãŒçµ‚äº†ã—ã¾ã—ãŸ');
        endCall('sender');
    });
}

// ãƒã‚¤ã‚¯ã®ãƒŸãƒ¥ãƒ¼ãƒˆ/ã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆ
function toggleMute(mode) {
    if (localStream) {
        const audioTracks = localStream.getAudioTracks();
        if (audioTracks.length > 0) {
            const isEnabled = audioTracks[0].enabled;
            audioTracks[0].enabled = !isEnabled;
            
            const btn = document.getElementById(mode + 'MicBtn');
            if (!isEnabled) {
                btn.classList.remove('off');
                btn.classList.add('normal');
                btn.textContent = 'ğŸ¤';
                log('ãƒã‚¤ã‚¯ON');
            } else {
                btn.classList.remove('normal');
                btn.classList.add('off');
                btn.textContent = 'ğŸ”‡';
                log('ãƒã‚¤ã‚¯OFF');
            }
        }
    }
}

// ã‚«ãƒ¡ãƒ©ã®ON/OFF
function toggleCamera(mode) {
    if (localStream) {
        const videoTracks = localStream.getVideoTracks();
        if (videoTracks.length > 0) {
            const isEnabled = videoTracks[0].enabled;
            videoTracks[0].enabled = !isEnabled;
            
            const btn = document.getElementById(mode + 'CameraBtn');
            if (!isEnabled) {
                btn.classList.remove('off');
                btn.classList.add('normal');
                btn.textContent = 'ğŸ“·';
                log('ã‚«ãƒ¡ãƒ©ON');
            } else {
                btn.classList.remove('normal');
                btn.classList.add('off');
                btn.textContent = 'ğŸ“µ';
                log('ã‚«ãƒ¡ãƒ©OFF');
            }
        }
    }
}

// è‡ªåˆ†ã®æ˜ åƒè¡¨ç¤ºã®ON/OFF
function toggleSelfView(mode) {
    const localVideo = document.getElementById(mode + 'LocalVideo');
    const btn = document.getElementById(mode + 'SelfViewBtn');
    
    if (localVideo.classList.contains('hidden')) {
        localVideo.classList.remove('hidden');
        btn.classList.remove('off');
        btn.classList.add('normal');
        btn.textContent = 'ğŸ‘ï¸';
        log('è‡ªåˆ†ã®æ˜ åƒè¡¨ç¤ºON');
    } else {
        localVideo.classList.add('hidden');
        btn.classList.remove('normal');
        btn.classList.add('off');
        btn.textContent = 'ğŸ™ˆ';
        log('è‡ªåˆ†ã®æ˜ åƒè¡¨ç¤ºOFF');
    }
}

// é€šè©±çµ‚äº†
function endCall(mode) {
    log('é€šè©±ã‚’çµ‚äº†/ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');

    // 1. PeerJSã®æ¥ç¶šã‚’é–‰ã˜ã‚‹
    if (currentCall) {
        if (!currentCall.open) {
            log('é€šè©±æ¥ç¶šã¯æ—¢ã«é–‰ã˜ã¦ã„ã¾ã™ã€‚');
        } else {
            currentCall.close();
            log('PeerJSã®é€šè©±æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸã€‚');
        }
        currentCall = null;
    }

    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ï¼‰ã‚’å®Œå…¨ã«åœæ­¢
    if (localStream) {
        localStream.getTracks().forEach(track => {
            track.stop(); // å„ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢
        });
        localStream = null;
        log('ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
    }

    // 3. ãƒ“ãƒ‡ã‚ªè¦ç´ ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
    // senderã¨receiverä¸¡æ–¹ã®è¦ç´ ã‚’ã‚¯ãƒªã‚¢å¯¾è±¡ã«ã™ã‚‹
    ['sender', 'receiver'].forEach(role => {
        const localVideoEl = document.getElementById(`${role}LocalVideo`);
        const remoteVideoEl = document.getElementById(`${role}RemoteVideo`);
        if (localVideoEl && localVideoEl.srcObject) localVideoEl.srcObject = null;
        if (remoteVideoEl && remoteVideoEl.srcObject) remoteVideoEl.srcObject = null;
    });
    log('å…¨ã¦ã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');

    // 4. UIã‚’ãƒªã‚»ãƒƒãƒˆ
    if (mode === 'sender') {
        document.getElementById('senderCallArea').classList.add('hidden');
        // ç™ºä¿¡ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
        const callBtn = document.getElementById('callBtn');
        if (callBtn) callBtn.disabled = false;
    } else {
        document.getElementById('receiverCallArea').classList.add('hidden');
        // å¿…è¦ã«å¿œã˜ã¦å—ä¿¡è€…å´ã®UIã‚‚ãƒªã‚»ãƒƒãƒˆ
    }
    
    log('âœ… é€šè©±ãŒæ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸã€‚');
}

function goBackToHome() {
    log('åˆæœŸç”»é¢ã«æˆ»ã‚Šã¾ã™...');

    // 1. é€²è¡Œä¸­ã®é€šè©±ã¨ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å®Œå…¨ã«çµ‚äº†ã•ã›ã‚‹
    // userTypeãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§endCallã‚’å‘¼ã¶
    if (userType) {
        endCall(userType);
    }
    
    // 2. PeerJSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ®‹ã£ã¦ã„ã‚Œã°ç ´æ£„ã™ã‚‹
    if (peer && !peer.destroyed) {
        peer.destroy();
        peer = null;
        log('PeerJSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç ´æ£„ã—ã¾ã—ãŸã€‚');
    }

    // 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
    config = { receiverId: null, serverUrl: null, authCode: null };
    sessionId = null;
    pushSubscription = null;
    // userTypeã¯æœ€å¾Œã«ãƒªã‚»ãƒƒãƒˆ
    
    // 4. UIã‚’åˆæœŸç”»é¢ã«æˆ»ã™
    document.getElementById('senderScreen').classList.add('hidden');
    document.getElementById('receiverScreen').classList.add('hidden');
    document.getElementById('senderSetup').classList.add('hidden');
    document.getElementById('receiverSetup').classList.add('hidden');
    document.getElementById('setupScreen').classList.remove('hidden');

    // userTypeã‚’ãƒªã‚»ãƒƒãƒˆ
    userType = null;
    document.getElementById('userType').value = '';

    log('âœ… åˆæœŸç”»é¢ã«æˆ»ã‚Šã¾ã—ãŸã€‚');
}


// ICEã‚µãƒ¼ãƒãƒ¼è¨­å®šã®å–å¾—ãƒ•ãƒƒã‚¯ï¼ˆç¾çŠ¶ã¯STUNã®ã¿è¿”å´ï¼‰
async function getIceServers() {
    try {
        // å°†æ¥: ã‚µãƒ¼ãƒã® /ice-config ã‹ã‚‰å–å¾—ï¼ˆAPIã‚­ãƒ¼ç­‰ã§ä¿è­·ï¼‰
        // const res = await fetch(`${config.serverUrl}/ice-config`, { headers: { 'X-API-Key': '...' }});
        // const data = await res.json();
        // return data.iceServers;

        // ç¾åœ¨ã¯STUNã®ã¿ï¼ˆIPv6å‰æã®ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆï¼‰
        return [{ urls: 'stun:stun.l.google.com:19302' }];
    } catch (e) {
        log(`ICEè¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        return [{ urls: 'stun:stun.l.google.com:19302' }];
    }
}

// åˆæœŸåŒ–
log('ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Service Workerã‚’ç™»éŒ²ã™ã‚‹
// ã“ã‚Œã«ã‚ˆã‚Šã€PWAã¨ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã•ã‚Œã‚‹å‰ã«ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ—ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’èªè­˜ã§ãã‚‹
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
window.addEventListener('load', async () => {
    log('ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚');

    // ã¾ãšService Workerã‚’ç™»éŒ²
    if ('serviceWorker' in navigator) {
        await registerServiceWorker().catch(err => {
            log('åˆæœŸService Workerç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
        });
    } else {
        log('Service Workeréå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™', 'warning');
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è‡ªå‹•å¿œç­”ãƒ•ãƒ­ãƒ¼ã«å…¥ã‚‹ã‹åˆ¤æ–­
    const urlParams = new URLSearchParams(window.location.search);
    const isAutoAnswer = urlParams.get('autoAnswer') === 'true';
    const incomingSessionId = urlParams.get('sessionId');
    const incomingSenderId = urlParams.get('senderId');

    // ä¿å­˜æ¸ˆã¿è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§UIã«åæ˜ 
    const hasSavedConfig = loadSavedConfig();

    if (isAutoAnswer && incomingSessionId && incomingSenderId) {
        log(`è‡ªå‹•å¿œç­”ãƒ¢ãƒ¼ãƒ‰ã‚’æ¤œå‡º: SessionID=${incomingSessionId}, SenderID=${incomingSenderId}`);
        
        if (hasSavedConfig) {           
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’é£›ã°ã—ã¦å—ä¿¡è€…ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('senderSetup').classList.add('hidden');
            document.getElementById('receiverSetup').classList.add('hidden');
            document.getElementById('receiverScreen').classList.remove('hidden');
            document.getElementById('receiverStatus').textContent = 'ç€ä¿¡ã«å¿œç­”ä¸­...';
            document.getElementById('receiverStatus').className = 'status status-warning';
         
            // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰è‡ªå‹•å¿œç­”ã‚’é–‹å§‹
            setTimeout(() => autoAnswerCall(incomingSessionId, incomingSenderId), 500);
        } else {
            log('è‡ªå‹•å¿œç­”ãŒå¿…è¦ã§ã™ãŒã€ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚', 'error');
            alert('åˆæœŸè¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ä¸€åº¦å—ä¿¡è€…ã¨ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
        }
    } 
    // é€šå¸¸èµ·å‹•æ™‚ã¯loadSavedConfigã«ã‚ˆã£ã¦UIãŒå¾©å…ƒã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’å¾…ã¤
});

    </script>
</body>
</html>
