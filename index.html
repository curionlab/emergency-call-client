<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
:root {
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-border: rgba(94, 82, 64, 0.2);
  --color-card-border: rgba(94, 82, 64, 0.12);
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-primary: var(--color-teal-300);
  }
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--color-background);
  color: var(--color-text);
  line-height: 1.6;
  padding: 20px;
}

.container { max-width: 800px; margin: 0 auto; }
.card {
  background: var(--color-surface);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

h2 { margin-bottom: 16px; }
h3 { margin-bottom: 12px; font-size: 18px; }

.btn {
  display: inline-block;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
  margin-top: 12px;
}

.btn-primary {
  background: var(--color-primary);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--color-primary-hover);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.emergency-btn {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  font-size: 28px;
  background: linear-gradient(135deg, var(--color-red-400), var(--color-red-500));
  color: white;
  border: 4px solid white;
  box-shadow: 0 8px 24px rgba(192, 21, 47, 0.3);
  margin: 30px auto;
  display: block;
}

.emergency-btn:hover:not(:disabled) { transform: scale(1.05); }

.status {
  padding: 8px 16px;
  border-radius: 20px;
  display: inline-block;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 16px;
}

.status-success { background: rgba(33, 128, 141, 0.15); color: var(--color-primary); }
.status-warning { background: rgba(168, 75, 47, 0.15); color: rgba(168, 75, 47, 1); }
.status-error { background: rgba(192, 21, 47, 0.15); color: var(--color-red-500); }

input, select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  margin-top: 8px;
  font-size: 16px;
  background: var(--color-surface);
  color: var(--color-text);
}

label {
  display: block;
  font-weight: 600;
  margin-top: 16px;
}

.video-container {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  margin: 20px 0;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.video-controls {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 12px;
}

.control-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.control-btn:hover { background: rgba(0,0,0,0.8); }
.control-btn.end { background: var(--color-red-500); }

.log-box {
  max-height: 300px;
  overflow-y: auto;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 12px;
  font-family: monospace;
  font-size: 13px;
}

.log-entry {
  padding: 4px 0;
  border-bottom: 1px solid var(--color-border);
}

.hidden { display: none !important; }

.info-box {
  background: rgba(33, 128, 141, 0.1);
  padding: 16px;
  border-radius: 8px;
  margin: 16px 0;
  border-left: 4px solid var(--color-primary);
}

.code-box {
  background: rgba(0,0,0,0.05);
  padding: 12px;
  border-radius: 6px;
  font-family: monospace;
  font-size: 12px;
  word-break: break-all;
  margin-top: 8px;
}
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
        <div id="setupScreen">
            <div class="card">
                <h2>ğŸš¨ ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ </h2>
                
                <div class="info-box">
                    <strong>ã‚·ã‚¹ãƒ†ãƒ ã®ç‰¹å¾´</strong>
                    <ul style="margin-top: 8px; margin-left: 20px;">
                        <li>âœ“ ã‚ãªãŸã®æ“ä½œã§ã®ã¿é€šçŸ¥ç™ºå‹•</li>
                        <li>âœ“ VAPIDæ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä½¿ç”¨ï¼ˆiOS Safariå¯¾å¿œï¼‰</li>
                        <li>âœ“ PeerJS WebRTCã‚·ã‚°ãƒŠãƒªãƒ³ã‚°</li>
                        <li>âœ“ é€šè©±ã‚»ãƒƒã‚·ãƒ§ãƒ³IDè‡ªå‹•ç”Ÿæˆ</li>
                        <li>âœ“ èªè¨¼ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å—ä¿¡è€…ç™»éŒ²</li>
                        <li>âœ“ ã‚ªãƒ¼ãƒˆã‚¢ãƒ³ã‚µãƒ¼æ©Ÿèƒ½</li>
                    </ul>
                </div>

                <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—:</label>
                <select id="userType">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="sender">ç™ºä¿¡è€…ï¼ˆç·Šæ€¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™å´ï¼‰</option>
                    <option value="receiver">å—ä¿¡è€…ï¼ˆé€šçŸ¥ã‚’å—ã‘å–ã‚‹å´ï¼‰</option>
                </select>

                <button class="btn btn-primary" onclick="proceedToSetup()">æ¬¡ã¸</button>
            </div>
        </div>

        <!-- ç™ºä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
        <div id="senderSetup" class="hidden">
            <div class="card">
                <h2>ğŸ“ ç™ºä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
                
                <label>å—ä¿¡è€…ID:</label>
                <input type="text" id="receiverId" placeholder="ä¾‹: parent_A">

                <label>ã‚µãƒ¼ãƒãƒ¼URLï¼ˆé€šçŸ¥é€ä¿¡ç”¨ï¼‰:</label>
                <input type="text" id="serverUrl" placeholder="https://your-server.onrender.com" value="__your-server-url__">

                <div class="info-box" style="margin-top: 20px;">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</strong>
                    <p style="margin-top: 8px;">å—ä¿¡è€…IDã¯ã€å—ä¿¡è€…ãŒç™»éŒ²æ™‚ã«ä½¿ç”¨ã—ãŸIDã¨åŒã˜ã‚‚ã®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <button class="btn btn-primary" onclick="initSender()">ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
            </div>
        </div>

        <!-- å—ä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
        <div id="receiverSetup" class="hidden">
            <div class="card">
                <h2>ğŸ“± å—ä¿¡è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
                
                <label>å—ä¿¡è€…IDï¼ˆã‚ãªãŸã®IDï¼‰:</label>
                <input type="text" id="myReceiverId" placeholder="ä¾‹: parent_A">

                <label>èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆç™ºä¿¡è€…ã‹ã‚‰å—ã‘å–ã£ãŸ6æ¡ï¼‰:</label>
                <input type="text" id="authCode" placeholder="ä¾‹: 582937" maxlength="6">

                <label>ã‚µãƒ¼ãƒãƒ¼URL:</label>
                <input type="text" id="receiverServerUrl" placeholder="https://your-server.onrender.com" value="__your-server-url__">

                <div class="info-box" style="margin-top: 20px;">
                    <strong>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</strong>
                    <p style="margin-top: 8px;">èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯ç™ºä¿¡è€…ã‹ã‚‰åˆ¥ã®å®‰å…¨ãªæ–¹æ³•ï¼ˆé›»è©±ãªã©ï¼‰ã§å—ã‘å–ã£ã¦ãã ã•ã„ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€ã‚ãªãŸã ã‘ãŒã“ã®IDã«ç™»éŒ²ã§ãã¾ã™ã€‚</p>
                </div>

                <button class="btn btn-primary" onclick="initReceiver()">å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
            </div>
        </div>

        <!-- ç™ºä¿¡è€…ç”»é¢ -->
        <div id="senderScreen" class="hidden">
            <div class="card">
                <h2>ğŸ“ ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰</h2>
                <div id="senderStatus" class="status status-warning">åˆæœŸåŒ–ä¸­...</div>
                
                <button class="emergency-btn" id="callBtn" onclick="makeEmergencyCall()" disabled>
                    ç·Šæ€¥<br>ã‚³ãƒ¼ãƒ«
                </button>

                <div id="senderCallArea" class="hidden">
                    <div class="video-container">
                        <video id="senderLocalVideo" autoplay muted playsinline></video>
                        <video id="senderRemoteVideo" autoplay playsinline style="position: absolute; top: 0; left: 0;"></video>
                        <div class="video-controls">
                            <button class="control-btn" onclick="toggleMute('sender')">ğŸ¤</button>
                            <button class="control-btn end" onclick="endCall('sender')">ğŸ“</button>
                            <button class="control-btn" onclick="toggleVideo('sender')">ğŸ“¹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å—ä¿¡è€…ç”»é¢ -->
        <div id="receiverScreen" class="hidden">
            <div class="card">
                <h2>ğŸ“± å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰</h2>
                <div id="receiverStatus" class="status status-warning">åˆæœŸåŒ–ä¸­...</div>
                
                <div id="subscriptionInfo" class="hidden">
                    <h3>ç™»éŒ²æƒ…å ±</h3>
                    <p>ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è³¼èª­ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
                    <div class="code-box" id="subscriptionData"></div>
                </div>

                <div id="receiverCallArea" class="hidden">
                    <div class="video-container">
                        <video id="receiverRemoteVideo" autoplay playsinline></video>
                        <video id="receiverLocalVideo" autoplay muted playsinline style="position: absolute; bottom: 20px; right: 20px; width: 150px; border: 2px solid white; border-radius: 8px;"></video>
                        <div class="video-controls">
                            <button class="control-btn" onclick="toggleMute('receiver')">ğŸ¤</button>
                            <button class="control-btn end" onclick="endCall('receiver')">ğŸ“</button>
                            <button class="control-btn" onclick="toggleVideo('receiver')">ğŸ“¹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ­ã‚° -->
        <div class="card">
            <h3>ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h3>
            <div class="log-box" id="logBox"></div>
        </div>
    </div>

    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

    <script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let userType = null;
let config = {
    receiverId: null,
    serverUrl: null,
    authCode: null
};
let peer = null;
let currentCall = null;
let localStream = null;
let pushSubscription = null;
let sessionId = null;

// ãƒ­ã‚°é–¢æ•°
function log(msg, type = 'info') {
    const logBox = document.getElementById('logBox');
    const time = new Date().toLocaleTimeString('ja-JP');
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.textContent = `[${time}] ${msg}`;
    logBox.appendChild(entry);
    logBox.scrollTop = logBox.scrollHeight;
    console.log(`[${type}] ${msg}`);
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²è¡Œ
function proceedToSetup() {
    const type = document.getElementById('userType').value;
    if (!type) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    userType = type;
    document.getElementById('setupScreen').classList.add('hidden');
    
    if (type === 'sender') {
        document.getElementById('senderSetup').classList.remove('hidden');
    } else {
        document.getElementById('receiverSetup').classList.remove('hidden');
    }
}

// ç™ºä¿¡è€…åˆæœŸåŒ–
async function initSender() {
    // UIã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ä¿å­˜
    saveConfig();
    
    if (!config.receiverId || !config.serverUrl) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    document.getElementById('senderSetup').classList.add('hidden');
    document.getElementById('senderScreen').classList.remove('hidden');
    
    log('ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...');

    // PeerJSæ¥ç¶šã‚’ç®¡ç†ã™ã‚‹é–¢æ•°ã‚’å®šç¾©
    function connectToPeerJS() {
        if (peer && !peer.destroyed) {
            log('æ—¢å­˜ã®Peeræ¥ç¶šã‚’ç ´æ£„ã—ã¾ã™ã€‚');
            peer.destroy();
        }

        const peerId = 'sender_' + Date.now();
        log(`PeerJSã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šè©¦è¡Œ... ID: ${peerId}`);
        document.getElementById('senderStatus').textContent = 'ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šä¸­...';
        document.getElementById('senderStatus').className = 'status status-warning';
        document.getElementById('callBtn').disabled = true;

        // PeerJSåˆæœŸåŒ–ï¼ˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã¨å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ï¼‰
        peer = new Peer(peerId, {
            host: '0.peerjs.com',
            secure: true,
            port: 443,
            pingInterval: 5000 // 5ç§’ã”ã¨ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¦æ¥ç¶šã‚’ç¶­æŒ
        });
        
        peer.on('open', (id) => {
            log(`âœ… PeerJSæ¥ç¶šæˆåŠŸ: ${id}`);
            document.getElementById('senderStatus').textContent = 'æº–å‚™å®Œäº†';
            document.getElementById('senderStatus').className = 'status status-success';
            document.getElementById('callBtn').disabled = false;
        });
        
        // ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒä¸€æ™‚çš„ã«åˆ‡æ–­ã•ã‚ŒãŸå ´åˆ
        peer.on('disconnected', () => {
            log('PeerJSã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚è‡ªå‹•å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...', 'warning');
            document.getElementById('senderStatus').textContent = 'å†æ¥ç¶šä¸­...';
            document.getElementById('senderStatus').className = 'status status-warning';
            // PeerJSã¯å†…éƒ¨ã§è‡ªå‹•çš„ã«å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™
        });

        // æ¥ç¶šãŒå®Œå…¨ã«é–‰ã˜ãŸå ´åˆï¼ˆdestroyã•ã‚ŒãŸæ™‚ãªã©ï¼‰
        peer.on('close', () => {
            log('PeerJSæ¥ç¶šãŒå®Œå…¨ã«é–‰ã˜ã¾ã—ãŸã€‚', 'error');
        });

        // ä½•ã‚‰ã‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
        peer.on('error', (err) => {
            log(`PeerJSã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            document.getElementById('senderStatus').textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
            document.getElementById('senderStatus').className = 'status status-error';
            
            // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
            if (err.type === 'network' || err.type === 'server-error') {
                log('æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€5ç§’å¾Œã«å†æ¥ç¶šã—ã¾ã™ã€‚');
                setTimeout(connectToPeerJS, 5000);
            } else if (err.type !== 'peer-unavailable') {
                 log('å›å¾©ä¸èƒ½ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚');
            }
        });
        
        // ç€ä¿¡å‡¦ç†ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“
        peer.on('call', (call) => {
            log('ç€ä¿¡ã‚’å—ä¿¡ï¼ˆå—ä¿¡è€…ãŒæ¥ç¶šï¼‰');
            answerIncomingCall(call);
        });
    }

    // åˆå›ã®æ¥ç¶šã‚’é–‹å§‹
    connectToPeerJS();
}


// å—ä¿¡è€…åˆæœŸåŒ–
async function initReceiver() {
    // UIã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ä¿å­˜
    saveConfig();
    // authCodeã¯ä¸€æ™‚çš„ãªã‚‚ã®ãªã®ã§ä¿å­˜ã—ãªã„
    config.authCode = document.getElementById('authCode').value;
    
    if (!config.receiverId || !config.authCode || !config.serverUrl) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    if (config.authCode.length !== 6) {
        alert('èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯6æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    document.getElementById('receiverSetup').classList.add('hidden');
    document.getElementById('receiverScreen').classList.remove('hidden');
    
    log('å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...');
    
    // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è³¼èª­
    await subscribeToPush();
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•å¿œç­”ãƒã‚§ãƒƒã‚¯
    checkAutoAnswer();
}

// Service Workerç™»éŒ²
async function registerServiceWorker() {
    try {
        if (!('serviceWorker' in navigator)) {
            throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Service Workerã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
        }

        log('Service Workerã‚’ç™»éŒ²ä¸­...');
        
        // ç‰©ç†ãƒ•ã‚¡ã‚¤ãƒ« '/sw.js' ã‚’ç™»éŒ²
        const registration = await navigator.serviceWorker.register('/sw.js');
        
        log('âœ… Service Workerç™»éŒ²å®Œäº†');
        return registration;
        
    } catch (error) {
        log(`Service Workerã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        // ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«ã‚‚è¡¨ç¤º
        document.getElementById('receiverStatus').textContent = `ç™»éŒ²å¤±æ•—: ${error.message}`;
        document.getElementById('receiverStatus').className = 'status status-error';
        throw error; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¦å‡¦ç†ã‚’ä¸­æ–­
    }
}


// ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è³¼èª­
async function subscribeToPush() {
    try {
        log('ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’è³¼èª­ä¸­...');

        // æ©Ÿèƒ½åˆ¤å®šï¼ˆiOSã¯ç‰¹ã«å³ã—ã„è¦ä»¶ãŒã‚ã‚‹ãŸã‚è©³ç´°ã«ãƒã‚§ãƒƒã‚¯ï¼‰
        if (!('serviceWorker' in navigator)) {
            throw new Error('Service Workeréå¯¾å¿œã§ã™ã€‚');
        }
        if (!('PushManager' in window)) {
            // iOSã§ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰èµ·å‹•ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ’ãƒ³ãƒˆ
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            if (/iP(ad|hone|od)/.test(navigator.userAgent) && !isStandalone) {
                 throw new Error('Push APIéå¯¾å¿œã§ã™ã€‚iOSã§ã¯ã€ã¾ãšãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‹ã‚‰ã€ãã®ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
            }
            throw new Error('Push APIéå¯¾å¿œç’°å¢ƒã§ã™ï¼ˆiOSã¯16.4+ã®ãƒ›ãƒ¼ãƒ ç”»é¢Webã‚¢ãƒ—ãƒªãŒå¿…è¦ï¼‰');
        }
        if (typeof Notification === 'undefined') {
            throw new Error('Notification APIéå¯¾å¿œã§ã™ã€‚iOSã¯16.4ä»¥ä¸Šã§ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ å¾Œã€å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // é€šçŸ¥æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            throw new Error('é€šçŸ¥æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }
        
        const registration = await navigator.serviceWorker.ready;

        
        // VAPIDã‚­ãƒ¼ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ï¼‰
        const vapidPublicKey = '__REDACTED_VAPID_PUBLIC_KEY__';
        
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });
        
        pushSubscription = subscription;
        log('ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­å®Œäº†');
        
        // ã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²
        await registerToServer(subscription);
        
    } catch (error) {
        log(`ãƒ—ãƒƒã‚·ãƒ¥è³¼èª­ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

// ã‚µãƒ¼ãƒãƒ¼ã«è³¼èª­æƒ…å ±ã‚’ç™»éŒ²
async function registerToServer(subscription) {
    try {
        log('ã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²ä¸­...');
        
        const response = await fetch(`${config.serverUrl}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receiverId: config.receiverId,
                authCode: config.authCode,
                subscription: subscription
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            log('âœ… ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²æˆåŠŸ', 'success');
            document.getElementById('receiverStatus').textContent = 'é€šçŸ¥å¾…æ©Ÿä¸­';
            document.getElementById('receiverStatus').className = 'status status-success';
            
            document.getElementById('subscriptionInfo').classList.remove('hidden');
            document.getElementById('subscriptionData').textContent = 
                `å—ä¿¡è€…ID: ${config.receiverId}\nç™»éŒ²æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;
        } else {
            throw new Error(result.error || 'ç™»éŒ²å¤±æ•—');
        }
        
    } catch (error) {
        log(`ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

// ---ã“ã“ã‹ã‚‰è¿½åŠ ---

// è¨­å®šã‚’localStorageã«ä¿å­˜ã™ã‚‹
function saveConfig() {
    // ç¾åœ¨ã®UIãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰æœ€æ–°ã®å€¤ã‚’å–å¾—ã—ã¦configã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°
    // userTypeã«å¿œã˜ã¦ä¿å­˜ã™ã‚‹å†…å®¹ã‚’åˆ†ã‘ã‚‹
    if (userType === 'sender') {
        config.receiverId = document.getElementById('receiverId').value;
        config.serverUrl = document.getElementById('serverUrl').value;
    } else if (userType === 'receiver') {
        config.receiverId = document.getElementById('myReceiverId').value;
        config.serverUrl = document.getElementById('receiverServerUrl').value;
    }
    
    // userTypeã‚‚ä¿å­˜å¯¾è±¡ã«å«ã‚ã‚‹
    const configToSave = {
        userType: userType,
        receiverId: config.receiverId,
        serverUrl: config.serverUrl,
    };

    localStorage.setItem('emergencyCallConfig', JSON.stringify(configToSave));
    log('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}

// localStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
function loadSavedConfig() {
    const savedConfig = localStorage.getItem('emergencyCallConfig');
    if (savedConfig) {
        const parsedConfig = JSON.parse(savedConfig);
        config = { ...config, ...parsedConfig }; // ã‚°ãƒ­ãƒ¼ãƒãƒ«configã‚’æ›´æ–°
        
        // UIã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚å€¤ã‚’åæ˜ ã•ã›ã‚‹
        document.getElementById('userType').value = config.userType || '';
        document.getElementById('receiverId').value = config.receiverId || '';
        document.getElementById('myReceiverId').value = config.receiverId || '';
        document.getElementById('serverUrl').value = config.serverUrl || '';
        document.getElementById('receiverServerUrl').value = config.serverUrl || '';

        log('ä¿å­˜æ¸ˆã¿è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
        return true;
    }
    log('ä¿å­˜ã•ã‚ŒãŸè¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
    return false;
}


// Base64å¤‰æ›
function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// ç·Šæ€¥ã‚³ãƒ¼ãƒ«ç™ºä¿¡
async function makeEmergencyCall() {
    try {
        log('ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚’é–‹å§‹...');
        document.getElementById('callBtn').disabled = true;
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
        sessionId = 'emergency_' + Date.now();
        log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}`);
        
        // ãƒ¡ãƒ‡ã‚£ã‚¢å–å¾—
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        
        log('ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
        document.getElementById('senderLocalVideo').srcObject = localStream;
        document.getElementById('senderCallArea').classList.remove('hidden');
        
        // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
        await sendPushNotification();
        
        // PeerJSé€šè©±å¾…æ©Ÿï¼ˆå—ä¿¡è€…ã‹ã‚‰ã®æ¥ç¶šã‚’å¾…ã¤ï¼‰
        log('å—ä¿¡è€…ã®æ¥ç¶šã‚’å¾…æ©Ÿä¸­...');
        
    } catch (error) {
        log(`ç™ºä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        document.getElementById('callBtn').disabled = false;
    }
}

// ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
async function sendPushNotification() {
    try {
        log('ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ä¸­...');
        
        const response = await fetch(`${config.serverUrl}/send-notification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                receiverId: config.receiverId,
                sessionId: sessionId,
                senderId: peer.id,
                title: 'ğŸš¨ ç·Šæ€¥ã‚³ãƒ¼ãƒ«',
                body: 'ç·Šæ€¥é€šè©±ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚ã‚¿ãƒƒãƒ—ã—ã¦å¿œç­”ã—ã¦ãã ã•ã„ã€‚'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            log('âœ… ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡æˆåŠŸ', 'success');
        } else {
            throw new Error(result.error || 'é€šçŸ¥é€ä¿¡å¤±æ•—');
        }
        
    } catch (error) {
        log(`é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

// è‡ªå‹•å¿œç­”ãƒã‚§ãƒƒã‚¯
function checkAutoAnswer() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('autoAnswer') === 'true') {
        const sessionId = urlParams.get('sessionId');
        log(`è‡ªå‹•å¿œç­”ãƒ¢ãƒ¼ãƒ‰: ${sessionId}`);
        setTimeout(() => autoAnswerCall(sessionId), 1000);
    }
}

// è‡ªå‹•å¿œç­”
async function autoAnswerCall(sessionId, senderId) {
    try {
        log('è‡ªå‹•å¿œç­”ã‚’é–‹å§‹...');
        
        // ãƒ¡ãƒ‡ã‚£ã‚¢å–å¾—
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        
        document.getElementById('receiverLocalVideo').srcObject = localStream;
        document.getElementById('receiverCallArea').classList.remove('hidden');
        
        log('ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
        
        // PeerJSæ¥ç¶šï¼ˆå¼•æ•°ã§å—ã‘å–ã£ãŸsenderIdã‚’ä½¿ç”¨ï¼‰
        log(`ç™ºä¿¡è€…(${senderId})ã«æ¥ç¶šä¸­...`);
        
        const receiverPeer = new Peer('receiver_' + Date.now(), {
            host: '0.peerjs.com',
            secure: true,
            port: 443,
            // ICEã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚‚é©ç”¨
            config: { iceServers: await getIceServers() } 
        });
        
        receiverPeer.on('open', () => {
            log('PeerJSæ¥ç¶šå®Œäº†ã€ç™ºä¿¡è€…ã‚’å‘¼ã³å‡ºã—ä¸­...');
            const call = receiverPeer.call(senderId, localStream);
            
            if (!call) {
                log('ç™ºä¿¡è€…ã¸ã®æ¥ç¶šé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                return;
            }

            currentCall = call;
            
            call.on('stream', (remoteStream) => {
                log('ç™ºä¿¡è€…ã®æ˜ åƒã‚’å—ä¿¡ã—ã¾ã—ãŸ');
                document.getElementById('receiverRemoteVideo').srcObject = remoteStream;
                document.getElementById('receiverStatus').textContent = 'é€šè©±ä¸­';
                document.getElementById('receiverStatus').className = 'status status-success';
            });

            call.on('close', () => {
                log('é€šè©±ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚');
                endCall('receiver');
            });

            call.on('error', (err) => {
                log(`é€šè©±ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            });
        });

        receiverPeer.on('error', (err) => {
            log(`å—ä¿¡è€…Peerã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
        });
        
    } catch (error) {
        log(`è‡ªå‹•å¿œç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        document.getElementById('receiverStatus').textContent = 'å¿œç­”å¤±æ•—';
        document.getElementById('receiverStatus').className = 'status status-error';
    }
}


// ç€ä¿¡å¿œç­”ï¼ˆç™ºä¿¡è€…å´ï¼‰
function answerIncomingCall(call) {
    currentCall = call;
    
    call.answer(localStream);
    
    call.on('stream', (remoteStream) => {
        log('å—ä¿¡è€…ã®æ˜ åƒã‚’å—ä¿¡');
        document.getElementById('senderRemoteVideo').srcObject = remoteStream;
    });
    
    call.on('close', () => {
        log('é€šè©±ãŒçµ‚äº†ã—ã¾ã—ãŸ');
        endCall('sender');
    });
}

// ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
function toggleMute(mode) {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        log(audioTrack.enabled ? 'ãƒã‚¤ã‚¯ON' : 'ãƒã‚¤ã‚¯OFF');
    }
}

// ãƒ“ãƒ‡ã‚ªåˆ‡ã‚Šæ›¿ãˆ
function toggleVideo(mode) {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        log(videoTrack.enabled ? 'ã‚«ãƒ¡ãƒ©ON' : 'ã‚«ãƒ¡ãƒ©OFF');
    }
}

// é€šè©±çµ‚äº†
function endCall(mode) {
    log('é€šè©±ã‚’çµ‚äº†ã—ã¾ã™...');

    // 1. PeerJSã®æ¥ç¶šã‚’é–‰ã˜ã‚‹
    if (currentCall) {
        currentCall.close();
        currentCall = null;
        log('PeerJSã®é€šè©±æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸã€‚');
    }

    // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ï¼‰ã‚’å®Œå…¨ã«åœæ­¢
    if (localStream) {
        localStream.getTracks().forEach(track => {
            track.stop(); // å„ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢
        });
        localStream = null;
        log('ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
    }

    // 3. ãƒ“ãƒ‡ã‚ªè¦ç´ ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ¨å¥¨ï¼‰
    const localVideoEl = document.getElementById(`${mode}LocalVideo`);
    const remoteVideoEl = document.getElementById(`${mode}RemoteVideo`);
    if (localVideoEl) localVideoEl.srcObject = null;
    if (remoteVideoEl) remoteVideoEl.srcObject = null;
    log('ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');

    // 4. UIã‚’ãƒªã‚»ãƒƒãƒˆ
    if (mode === 'sender') {
        document.getElementById('senderCallArea').classList.add('hidden');
        document.getElementById('callBtn').disabled = false;
    } else {
        document.getElementById('receiverCallArea').classList.add('hidden');
        // å¿…è¦ã«å¿œã˜ã¦å—ä¿¡è€…å´ã®UIã‚‚ãƒªã‚»ãƒƒãƒˆ
    }
    
    log('âœ… é€šè©±ãŒæ­£å¸¸ã«çµ‚äº†ã—ã¾ã—ãŸã€‚');
}


// ICEã‚µãƒ¼ãƒãƒ¼è¨­å®šã®å–å¾—ãƒ•ãƒƒã‚¯ï¼ˆç¾çŠ¶ã¯STUNã®ã¿è¿”å´ï¼‰
async function getIceServers() {
    try {
        // å°†æ¥: ã‚µãƒ¼ãƒã® /ice-config ã‹ã‚‰å–å¾—ï¼ˆAPIã‚­ãƒ¼ç­‰ã§ä¿è­·ï¼‰
        // const res = await fetch(`${config.serverUrl}/ice-config`, { headers: { 'X-API-Key': '...' }});
        // const data = await res.json();
        // return data.iceServers;

        // ç¾åœ¨ã¯STUNã®ã¿ï¼ˆIPv6å‰æã®ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆï¼‰
        return [{ urls: 'stun:stun.l.google.com:19302' }];
    } catch (e) {
        log(`ICEè¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        return [{ urls: 'stun:stun.l.google.com:19302' }];
    }
}

// åˆæœŸåŒ–
log('ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Service Workerã‚’ç™»éŒ²ã™ã‚‹
// ã“ã‚Œã«ã‚ˆã‚Šã€PWAã¨ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã•ã‚Œã‚‹å‰ã«ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ—ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’èªè­˜ã§ãã‚‹
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
window.addEventListener('load', async () => {
    log('ç·Šæ€¥ã‚³ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚');

    // ã¾ãšService Workerã‚’ç™»éŒ²
    if ('serviceWorker' in navigator) {
        await registerServiceWorker().catch(err => {
            log('åˆæœŸService Workerç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
        });
    } else {
        log('Service Workeréå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™', 'warning');
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è‡ªå‹•å¿œç­”ãƒ•ãƒ­ãƒ¼ã«å…¥ã‚‹ã‹åˆ¤æ–­
    const urlParams = new URLSearchParams(window.location.search);
    const isAutoAnswer = urlParams.get('autoAnswer') === 'true';
    const incomingSessionId = urlParams.get('sessionId');
    const incomingSenderId = urlParams.get('senderId');

    // ä¿å­˜æ¸ˆã¿è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§UIã«åæ˜ 
    const hasSavedConfig = loadSavedConfig();

    if (isAutoAnswer && incomingSessionId && incomingSenderId) {
        log(`è‡ªå‹•å¿œç­”ãƒ¢ãƒ¼ãƒ‰ã‚’æ¤œå‡º: SessionID=${incomingSessionId}, SenderID=${incomingSenderId}`);
        
        if (hasSavedConfig) {           
            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‚’é£›ã°ã—ã¦å—ä¿¡è€…ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('senderSetup').classList.add('hidden');
            document.getElementById('receiverSetup').classList.add('hidden');
            document.getElementById('receiverScreen').classList.remove('hidden');
            document.getElementById('receiverStatus').textContent = 'ç€ä¿¡ã«å¿œç­”ä¸­...';
            document.getElementById('receiverStatus').className = 'status status-warning';
         
            // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰è‡ªå‹•å¿œç­”ã‚’é–‹å§‹
            setTimeout(() => autoAnswerCall(incomingSessionId, incomingSenderId), 500);
        } else {
            log('è‡ªå‹•å¿œç­”ãŒå¿…è¦ã§ã™ãŒã€ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚', 'error');
            alert('åˆæœŸè¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ä¸€åº¦å—ä¿¡è€…ã¨ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
            // é€šå¸¸ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼ã¸
            loadSavedConfig();
        }
    } else {
        // é€šå¸¸èµ·å‹•æ™‚ã®å‡¦ç†
        loadSavedConfig();
    }
});

    </script>
</body>
</html>
